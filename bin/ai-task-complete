#!/bin/bash
# ai-task-complete - Mark a task as completed
# Usage: ai-task-complete TASK_ID [OPTIONS]

set -e

TEAM_AI_DIR="${HOME}/.team-ai"
TASKS_DIR="${TEAM_AI_DIR}/tasks"

# Get ISO 8601 timestamp
get_timestamp() {
    date -u +"%Y-%m-%dT%H:%M:%SZ"
}

show_help() {
    cat << EOF
Usage: ai-task-complete TASK_ID [OPTIONS]

Mark a task as completed.

Arguments:
  TASK_ID               The ID of the task to complete

Options:
  --result TEXT         Completion result/summary
  -h, --help           Show this help message

Example:
  ai-task-complete abc123 --result "Auth module implemented with JWT"
EOF
}

# Parse arguments
TASK_ID=""
RESULT=""

while [[ $# -gt 0 ]]; do
    case $1 in
        --result)
            RESULT="$2"
            shift 2
            ;;
        -h|--help)
            show_help
            exit 0
            ;;
        -*)
            echo "Unknown option: $1" >&2
            show_help >&2
            exit 1
            ;;
        *)
            TASK_ID="$1"
            shift
            ;;
    esac
done

if [ -z "${TASK_ID}" ]; then
    echo "Error: TASK_ID is required" >&2
    show_help >&2
    exit 1
fi

TASK_FILE="${TASKS_DIR}/${TASK_ID}.json"

if [ ! -f "${TASK_FILE}" ]; then
    echo "Error: Task not found: ${TASK_ID}" >&2
    exit 1
fi

# Lock for safety
LOCK_DIR="${TASKS_DIR}/.${TASK_ID}.update.lock"

acquire_lock() {
    local max_attempts=50
    local attempt=0
    while ! mkdir "${LOCK_DIR}" 2>/dev/null; do
        attempt=$((attempt + 1))
        if [ ${attempt} -ge ${max_attempts} ]; then
            echo "Error: Could not acquire lock on task ${TASK_ID}" >&2
            exit 1
        fi
        sleep 0.1
    done
}

release_lock() {
    rmdir "${LOCK_DIR}" 2>/dev/null || true
}

trap release_lock EXIT
acquire_lock

TIMESTAMP=$(get_timestamp)

if command -v python3 &> /dev/null; then
    python3 << PYTHON
import json, sys

with open('${TASK_FILE}', 'r') as f:
    task = json.load(f)

if task['status'] != 'in_progress':
    print(f"Error: Task is '{task['status']}', expected 'in_progress'.", file=sys.stderr)
    sys.exit(1)

task['status'] = 'completed'
task['completed_at'] = '${TIMESTAMP}'
result = """${RESULT}"""
if result:
    task['result'] = result

with open('${TASK_FILE}', 'w') as f:
    json.dump(task, f, indent=2)

print(f"Task completed: {task['title']}")
PYTHON
else
    status=$(grep -o '"status": "[^"]*"' "${TASK_FILE}" | head -1 | cut -d'"' -f4)
    if [ "${status}" != "in_progress" ]; then
        echo "Error: Task is '${status}', expected 'in_progress'." >&2
        exit 1
    fi
    TMP_FILE=$(mktemp)
    sed "s/\"status\": \"in_progress\"/\"status\": \"completed\"/" "${TASK_FILE}" | \
    sed "s/\"completed_at\": null/\"completed_at\": \"${TIMESTAMP}\"/" > "${TMP_FILE}"
    mv "${TMP_FILE}" "${TASK_FILE}"
    echo "Task completed"
fi
